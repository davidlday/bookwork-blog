---
layout: page
title: Story Search
comments: false
jquery: true
bookwormjs: true
---

<!--
TODO:
* Reuse Bookworm Analysis and Similar Stories displays from analyzer
*
-->

        <div id="search">
            <input id="searchText" type="text" style="width: 100%" placeholder="Search Stories..." />
        </div>
        <div id="searchStats"></div>
        <div id="pagination-top" class="text-center">
            <ul class="sync-pagination pagination-sm text-center"></ul>
        </div>
        <div id="results"></div>
        <div id="pagination-bottom" class="text-center">
            <ul class="sync-pagination pagination-sm text-center"></ul>
        </div>

        <script>
            // Get query text
            var query = getParameterByName('q') || '';
            var start = Number(getParameterByName('s')) || 0;
            var current_page = Number(getParameterByName('p')) || 1;
            // Default Pagination
            var rows = 10;
            var mlt_count = 5;
            var default_rows = 10;
            var total_results = 0;
            var total_pages = 0;
            var current_page = 1;

            // Controls what metrics are displayed.
            var display_results = [
                'syllable_count',
                'word_count',
                'sentence_count',
                'avg_syllables_per_word',
                'avg_words_per_sentence',
                'dialogue_word_percentage',
                'pov',
                'coleman_liau_index',
                'automated_readability_index',
                'flesch_kincaid_grade_level',
                'smog_index',
                'flesch_reading_ease',
                'gunning_fog_index',
                'rix',
                'lix',
            ];

            function displayAjaxError(thrownMessage) {
                // Update results stats
                $('#searchStats').empty();
                $('#searchStats').append(
                    "<p>Something went wrong. Please check your query and try again.</p>"
                );
                console.log(thrownMessage);
            }

            // Callback to show search results
            function displayResults(data) {

                // Refresh Global Variables
                start = Number( data.responseHeader.params.start ) || 0;
                rows = Number( data.responseHeader.params.rows ) || 10;
                query = data.responseHeader.params.q;
                total_results = data.response.numFound;
                total_pages = Math.ceil( total_results / rows );
                current_page = Math.ceil( (start / rows) + 1 );

                page_begin = start + 1;
                page_end = ( (start + rows) < total_results) ? (start + rows) : total_results;

                // Create Link
                var result_link = "?q=" + query +
                    "&p=" + current_page;

                // Update results stats div
                $('#searchStats').empty();
                $('#searchStats').append(
                    "Found " + data.response.numFound + " stories. Showing " + page_begin + "-" + page_end + "."
                );

                // Add results
                var res_counter = start + 1;
                $('#results').append("<hr />");
                $.each(data.response.docs, function(index, doc) {
                    var published_date = new Date(doc.pub_date);
                    // Populate results div
                    $('#results').append(
                        "<div class=\"result\" id=\"res-" + res_counter + "\"><h3>" +
                        res_counter + ".&nbsp;" +
                        doc.magazine + " >> <a href=\"" + doc.url + "\" target=\"story\">" +
                        doc.title + "</a></h3>" +
                        "<p class=\"font-75\">By " + doc.author.join(", ") + "<br />" +
                        "Published " + published_date.toLocaleDateString('en-us', defaults.date_options) + "<br />" +
                        "Search Relevance: " + doc.score +
                        "</p>" +
                        "<div class=\"accordion font-62\" id=\"det-" + res_counter + "\">"+
                        '<h3>Bookworm Analysis</h3>' +
                        '<table class="scrollTable" id="analysisTable">' +
                        '<thead><tr><td>Metric</td><td>Value</td></tr></thead>' +
                        '<tbody id="analysisTableBody-' + res_counter + '"></tbody>' +
                        '</table>' +
                        '<h3>Top 5 Similar Stories</h3>' +
                        '<table class="scrollTable" id="mltTable">' +
                        '<thead><tr><td>Title</td><td>Author</td><td>Magazine</td><td>Published</td></tr></thead>'+
                        '<tbody id="mltTableBody-' + res_counter + '"></tbody>' +
                        '</table>' +
                        "</div>"+
                        "<hr />"
                    );
                    populateAnalysisTableBody('#analysisTableBody-' + res_counter, display_results, doc);
                    populateMltTableBody('#mltTableBody-' + res_counter, data.moreLikeThis[doc.url].docs);
                    res_counter += 1;
                });

                // Collapse all accordions.
                $( "div.accordion" ).each( function() {
                    $(this).accordion({
                        active: null,
                        collapsible: true,
                        animate: 50,
                    });
                });

                // Refresh pagination
                $('.sync-pagination').twbsPagination({
                    totalPages: total_pages,
                    startPage:  current_page,
                    onPageClick: function (event, page) {
                        new_start = (page - 1) * rows;
                        window.location.href = '?q=' + query +
                            "&s=" + new_start;
                    }
                });

            }

            // Common Search
            function searchStories(query,start,rows,callback) {
                // Wipe out prior results
                $('#results').empty();
                // Craft search parameters
                var params = 'q=' + query +
                    '&wt=json' +
                    '&fl=magazine,title,url,id,author,pub_date,score,' + display_results.join() +
                    '&mlt=true&mlt.fl=text' +
                    '&mlt.count=' + mlt_count +
                    '&rows=' + rows +
                    '&start=' + start;
                // Invoke Search
                solrSearch(params, callback, displayAjaxError);
            }

            // Hook enter to search
            $('body').keypress(function(e) {
                if (e.keyCode == '13') {
                    query = $('#searchText').val();
                    window.location.href = '?q=' + query;
                }
            });

            // Perform the search if ready
            $(document).ready(function () {
                if (query != null && query != '') {
                    $('#searchText').val(query);
                    $('#searchStats').empty();
                    $('#searchStats').append("Searching...");
                    searchStories(query, start, rows, displayResults);
                }
            });

        </script>