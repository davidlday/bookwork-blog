---
layout: page
title: Statistics
comments: false
jquery: true
flot: true
bookwormjs: true
---

<!--
TODO:
* Add series selector (magazines)
* Add series highlighting per chart
 -->


        <style>
        table {
            width: auto;
        }
        td {
            font-size: 75%;
        }
        </style>

        <div id="loading_message" style="width: 100%;">
        Loading data...
        </div>
        <div id="legend"></div>
        <div id="magazine_dashboard" style="width: 100%; display: none;">
            <div id="magazine_selector" class="font-62"></div>
            <hr />
        </div>

        <script>

            var display_results = bwconfig.display_results;
            var magazine_list = [];
            var magazine_datatable;
            var colors = [];

            var chart_data = {};
            var charts = {};
            var options = {
                series: {
                    stack: true,
                    lines: {
                        show: false,
                        fill: true,
                        steps: false,
                    },
                    bars: {
                        align: 'center',
                        show: true,
                        barWidth: 0.25,
                        lineWidth: 0,
                        fill: 0.9,
                    },
                },
                selection: {
                    mode: "x",
                },
                legend: {
                    sorted: 'ascending',
                },
            };

            function loadDataAndDraw( binneddata ) {
                // Add result to data;
                var series_data = [];
                $.each( binneddata.bins, function(index, data) {
                    series_data.push( [data.bin, data.count] );
                });

                // Used to consistently order series across charts
                // and make coloring consistent
                var magazine_index = $.inArray(binneddata.magazine, magazine_list);

                chart_data[binneddata.metric][magazine_index] = {
                    label: binneddata.magazine,
                    hoverable: true,
                    clickable: true,
                    color: magazine_index,
                    data: series_data,
                };

                options.series.bars.barWidth = binneddata.binsize * 0.8;
                options['xaxis'] = binneddata.xaxis;

                $.each(chart_data, function(index, dataset) {
                    dataset.color = index;
                });

                // Make sure all magazines have been processed before drawing.
                // Still needs work.
                if ( chart_data[binneddata.metric].length == magazine_list.length && chart_data[binneddata.metric].every( isDefined ) ) {
                    charts[binneddata.metric] = $.plot('#histogram_' + binneddata.metric, chart_data[binneddata.metric], options);
                }

                // Now show the whole thing
                $('#loading_message').hide();
                $('#magazine_dashboard').show();

            }

            $(document).ready( function() {
                //Create initial charts
                var div_width = $('#magazine_dashboard').parent().width()
                var div_height = (div_width * 2) / 3;
                $.each( display_results, function( metric_index, metric ) {
                    var div_name = 'histogram_' + metric;
                    // Initialize data sets
                    chart_data[metric] = [];
                    // Add div for the chart
                    $('#magazine_dashboard').append("<h2>" + getFieldLabel(metric) + "</h2>" +
                        "<div id=\"" + div_name + "\" style=\"width: " + div_width + "px; height: " + div_height + "px;\">" +
                        "</div>" +
                        "<hr />");

                        $('#' + div_name).bind("plotselected", function (event, ranges) {
                            $("#selection").text(ranges.xaxis.from.toFixed(1) + " to " + ranges.xaxis.to.toFixed(1));
                            $.each(charts[metric].getXAxes(), function(_, axis) {
                                var opts = axis.options;
                                opts.min = ranges.xaxis.from;
                                opts.max = ranges.xaxis.to;
                            });
                            charts[metric].setupGrid();
                            charts[metric].draw();
                            charts[metric].clearSelection();
                        });

                    $('#' + div_name).dblclick( function (event) {
                            $.each(charts[metric].getXAxes(), function(_, axis) {
                                var opts = axis.options;
                                opts.min = null;
                                opts.max = null;
                            });
                            charts[metric].setupGrid();
                            charts[metric].draw();
                            charts[metric].clearSelection();
                    });

                    solrGetMagazines( function( magazines ) {
                        $.each( magazines, function( index, magazine ) {
                            if ($.inArray(magazine.name, magazine_list) == -1) {
                                magazine_list.push(magazine.name);
                            }
                            solrGetBinnedMetric(magazine.name,
                                metric,
                                function( data ) {
                                    loadDataAndDraw( data );
                                },
                                logAjaxError);
                        });
                    }, logAjaxError);
                });

            });
        </script>
