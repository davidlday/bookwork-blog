---
layout: page
title: Statistics
comments: false
jquery: true
flot: true
bookwormjs: true
---

<!--
TODO:
* Add series highlighting per chart
 -->

        <div id="messagebox" style="width: 100%;">
        Loading data...
        </div>
        <div id="legend"></div>
        <div id="selectors">
            <label for="magazines-select" style="display: block; margin: 30px 0 0 0;">Select A Magazine</label>
            <select name="magazines-select" id="magazines-select" class="font-62">
              <option value='*'>-ALL-</option>
            </select>
        </div>
        <div id="magazine_dashboard" style="width: 100%; display: none;">
            <hr />
        </div>

        <script>

            var display_results = bwconfig.display_results;
            var loaded = [];
            var magazine_list = [];
            var magazine_datatable;
            var colors = [];

            var datasets = {};
            var charts = {};
            var chartoptions = {};

            function loadSelectedMagazine() {
                var selected_magazine = $('#magazines-select').val();

                $.each( display_results, function( metric_index, metric ) {
                    if ($.inArray(selected_magazine, magazine_list) == -1) {
                        drawAllData( metric );
                    } else {
                        var dataset = [];
                        var options = getFlotChartOptions( metric );
                        $.each( datasets[metric], function( key, val ) {
                            if (key == selected_magazine) {
                                dataset.push(val);
                            }
                        });
                        charts[metric] = $.plot('#histogram_' + metric, dataset, options);
                    }
                });

            }

            function drawAllData( metric ) {
                var dataset = [];
                $.each(datasets[metric], function(key, val) {
                    dataset.push(val);
                });
                options = getFlotChartOptions( metric );
                charts[metric] = $.plot('#histogram_' + metric, dataset, options);
            }

            function loadDataAndDraw( data ) {
                // Add result to data;
                var series_data = [];
                $.each( data.bins, function(index, data) {
                    series_data.push( [data.bin, data.count] );
                });

                // Used to consistently order series across charts
                // and make coloring consistent
                var color_int = $.inArray(data.magazine, magazine_list);

                datasets[data.metric][data.magazine] = {
                    label: data.magazine,
                    hoverable: true,
                    clickable: true,
                    color: color_int,
                    data: series_data,
                };

                // Make sure all magazines have been processed before drawing.
                loaded[data.metric]++;
                if ( loaded[data.metric] == magazine_list.length ) {
                    drawAllData( data.metric );
                }

                // Now show the whole thing
                $('#messagebox').hide();
                $('#messagebox').empty();
                $('#magazine_dashboard').show();

            }

            function createCharts( magazines ) {
                //Create initial charts
                var div_width = $('#magazine_dashboard').parent().width()
                var div_height = (div_width * 2) / 3;
                $.each( display_results, function( metric_index, metric ) {
                    var div_name = 'histogram_' + metric;
                    // Initialize data sets
                    datasets[metric] = {};
                    // Add div for the chart
                    $( '#magazine_dashboard' ).append("<h2>" + getFieldLabel(metric) + "</h2>" +
                        "<div id=\"" + div_name + "\" style=\"width: " + div_width + "px; height: " + div_height + "px;\">" +
                        "</div>" +
                        "<hr />");

                    // Selection handler - zooms in on a selected section
                    $( '#' + div_name ).bind("plotselected", function (event, ranges) {
                        $("#selection").text(ranges.xaxis.from.toFixed(1) + " to " + ranges.xaxis.to.toFixed(1));
                        $.each(charts[metric].getXAxes(), function(_, axis) {
                            var opts = axis.options;
                            opts.min = ranges.xaxis.from;
                            opts.max = ranges.xaxis.to;
                        });
                        charts[metric].setupGrid();
                        charts[metric].draw();
                        charts[metric].clearSelection();
                    });

                    // Reset handler - double click returns graph to full
                    $( '#' + div_name ).dblclick( function (event) {
                            $.each(charts[metric].getXAxes(), function(_, axis) {
                                var opts = axis.options;
                                opts.min = null;
                                opts.max = null;
                            });
                            charts[metric].setupGrid();
                            charts[metric].draw();
                            charts[metric].clearSelection();
                    });

                    loaded[metric] = 0;

                    // For each magazine, load data and draw
                    $.each( magazines, function( index, magazine ) {
                        solrGetBinnedMetric(magazine.name,
                            metric,
                            function( data ) {
                                loadDataAndDraw( data );
                            },
                            logAjaxError);
                    });

                });
            }

            // Start the whole process
            $(document).ready( function() {
                solrGetMagazines( function( magazines ) {
                    $.each( magazines, function( index, magazine ) {
                        if ($.inArray(magazine.name, magazine_list) == -1) {
                            magazine_list.push(magazine.name);
                            $( '#magazines-select' ).append(
                                '<option>' + magazine.name + '</option>'
                            );
                        }
                    });
                    $( '#magazines-select' ).on('change', loadSelectedMagazine);
                    createCharts(magazines);
                }, logAjaxError);
            });
        </script>
