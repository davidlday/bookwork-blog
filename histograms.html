---
layout: page
title: Market Statistics
comments: false
jquery: true
googlecharts: true
bookwormjs: true
---
        <div id="loading_message" style="width: 100%;">
        Loading data...
        </div>
        <div id="magazine_dashboard" style="width: 100%;display: none;">
            <div id="magazine_selector" style="padding-bottom: 2em"></div>
            <hr />
        </div>

        <script>
            // Load the Visualization API and the piechart package.
            google.load('visualization', '1.0', {'packages':['corechart', 'controls']});
            google.setOnLoadCallback(initDashboard);

            var magazines = [];
            var magazine_datatable;
            var magazine_selector;
            var magazine_dashboard;
            var charts = [];

            function initDashboard() {

                $(document).ready( function() {

                    // Get a list of magazines from search
                    $.getJSON("http://bookworm.davidlday.com/public/scripts/storysearch.py?wt=json&q=*&fl=magazine&group=true&group.field=magazine&rows=99999&group.main=true", function( data) {
                        data.response.docs.forEach( function(doc) {
                            magazines.push(doc.magazine);
                        });

                        // Create selector control
                        magazine_selector = new google.visualization.ControlWrapper({
                            'controlType': 'CategoryFilter',
                            'containerId': 'magazine_selector',
                            'options': {
                                'filterColumnLabel': 'Magazine',
                                'values': magazines,
                                'ui': {
                                    'allowTyping': true,
                                    'allowMultiple': false,
                                    'selectedValuesLayout': 'belowStacked'
                                },
                            },
                        });

                    });

                    // Get full data
                    $.getJSON("http://bookworm.davidlday.com/public/scripts/storysearch.py?q=*&fl=*&wt=json&rows=99999999", function( data ) {
                        // Define DataTable
                        magazine_datatable = new google.visualization.DataTable();
                        magazine_datatable.addColumn('string', 'Magazine');
                        magazine_datatable.addColumn('string', 'Story URL');
                        $.each( histogram_settings, function( metric, options) {
                            magazine_datatable.addColumn('number', histogram_settings[metric].chart_options.title);
                        });

                        // Populate magazine_datatable
                        data.response.docs.forEach( function( doc ) {
                            var data_row = [doc.magazine, doc.url];
                            $.each( histogram_settings, function( metric, options) {
                                data_row.push(doc[metric]);
                            });
                            magazine_datatable.addRow(data_row);
                        });

                        // Create a dashboard.
                        magazine_dashboard = new google.visualization.Dashboard(document.getElementById('magazine_dashboard'));

                        //Create initial charts
                        var index = 2; // Offset to account for Magazine and Story URL columns
                        $.each( histogram_settings, function( metric ) {
                            var chart = new google.visualization.ChartWrapper({
                                'chartType': 'Histogram',
                                'containerId': 'histogram_' + metric,
                                'options': histogram_settings[metric].chart_options,
                                'view': {
                                    'columns': [1, index]
                                },
                            });
                            charts.push(chart);
                            // Add div for the chart
                            $('#magazine_dashboard').append("<div id=\"histogram_" + metric + "\" style=\"width: 100%; height: 800px\"></div><hr />");
                            index++;
                        });

                        // Bind charts to selector
                        magazine_dashboard.bind(magazine_selector, charts);

                        // Draw the dashboard
                        magazine_dashboard.draw(magazine_datatable);

                        // Now show the whole thing
                        $('#loading_message').hide();
                        $('#magazine_dashboard').show();
                    });
                });
            };
        </script>
