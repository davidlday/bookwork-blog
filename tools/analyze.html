---
layout: page
title: Tools - Analyzer
comments: false
jquery: true
snapsvg: true
bookwormjs: true
noToc: true
---
        <p>See how a story compares statistically to the magazines I've analyzed.</p>
        {% include bwdownload.html %}
        <hr />
        <div id="readme" class="accordion font-75">
            <h3>README</h3>
            <table>
                <tbody><tr><td>
                <p>When you run the analyzer, you'll get the following four perspectives on the story:</p>
                <p class="font-bold">Bookworm Analysis</p>
                <p>This is a list of the raw metrics for the piece analyzed.</p>
                <p class="font-bold">Market Gauge</p>
                <p>This compares the raw metrics from the piece analyzed to the statistics for each market. The gauges show green, yellow, and red instead of numbers to emphasize the idea that the raw numbers are not the focus. The summary shows how statistically similar the piece is overall to each magazine, while gauges for individual metrics are shown under each magazine heading. The summary uses absolute values, so it runs red to green. The details for each magazine, however, puts green in the middle, because for an individual metric it's useful to know if the analyzed piece is above or below a market's mean value. There's no weighting used, meaning every metric is given equal footing, because I don't have enough data to know which, if any, are more important.</p>
<!--
                <p class="font-bold">Magazines with Stories in the Top Similar Stories</p>
                <p>This is a bit of statistical analysis called <a href="http://opensourceconnections.com/blog/2013/09/30/easy-k-nn-document-classification-with-solr-and-python/" target="_blank">k-nearest neighbors</a>. Looking at a set of similar stories and seeing which magazines they represent gives us another way of figuring out which market(s) a story might fit in. How are the similar stories selected? Great question. That brings us to the last perspective...</p>
                <p class="font-bold ss-title"></p>
                <p>This is accomplished through a bit of search engine voodoo. It's based on something called Term Vectors, which is a fancy way of saying the number of times each word appears in a story. It doesn't look at all words, though, but rather selects what are considered Interesting Terms. I still don't understand the process well enough to explain it, but it's a widely used approach to finding similar documents around the web. If you interested in learning more, see the Solr documentation for the <a href="https://wiki.apache.org/solr/MoreLikeThisHandler" target="_blank">More Like This Handler</a>.</p>
-->
                <p class="font-bold">General Notes</p>
                <ul>
                    <li>Nothing from this form is saved anywhere.</li>
                    <li>Plain text only.</li>
                    <li>Everything between double quotes (") is considered dialogue.</li>
                    <li>Section separators (e.g. #) are ignored.</li>
                    <li>Paragraphs are separated by one or more line breaks (return). Multiple consecutive line breaks are considered as one.</li>
                    <li>The formulae for the readability scores vary across implementations. Scores here may not exactly match scores from another tool.</li>
                </ul>
                </td></tr></tbody>
            </table>
        </div>
        <hr />
        <div id="story" style="display: none;">
            <input id="storyFile" type="file" />
            <button id="extractionButton">Extract Text</button>
            <textarea id="storyText" class="storyText" placeholder="Paste story here..."></textarea>
            <button id="analyzeButton">Analyze</button>
        </div>
        <div id="results-message" style="display: none;">Running analysis...</div>
        <div id="results" class="font-75" style="display: none;">
            <h3>Bookworm Analysis</h3>
            <table class="scrollTable" id="analysisTable">
                <thead id="analysisTableHead">
                    <tr>
                        <td>Metric</td>
                        <td>Value</td>
                    </tr>
                </thead>
                <tbody id="analysisTableBody" class="font-75">
                </tbody>
            </table>
            <hr />
            <h3>Market Gauge</h3>
            <div id="marketComparison" class="accordion font-75" style="display: none;">
                <p>Summary</p>
                <table class="scrollTable" id="marketSummary">
                    <tbody id="marketSummary-TableBody"></tbody>
                </table>
            </div>
            <hr >
            <h3>Word Frequency</h3>
            <table class="scrollTable" id="wordFrequencyTable">
                <thead id="wordFrequencyTableHead">
                    <tr>
                        <td>Word</td>
                        <td>Frequency</td>
                        <td>Percentage</td>
                    </tr>
                </thead>
                <tbody id="wordFrequencyTableBody" class="font-75">
                </tbody>
            </table>
            <hr />
<!--
            <h3>Magazines with Stories in the Top Similar Stories</h3>
            <table class="scrollTable" id="knnTable">
                <thead id="knnTableHead" class="text-center">
                    <tr>
                        <td>Magazine</td>
                        <td>Average Similarity Score</td>
                        <td>Number of Similar Stories</td>
                    </tr>
                </thead>
                <tbody id="knnTableBody" class="font-75">
                </tbody>
            </table>
            <hr />
            <h3 id="ss-title" class="ss-title"></h3>
            <table class="scrollTable" id="mltTable">
                <thead id="mltTableHead">
                    <tr>
                        <td>Title</td>
                        <td>Author</td>
                        <td>Magazine</td>
                        <td>Published</td>
                    </tr>
                </thead>
                <tbody id="mltTableBody" class="font-75">
                </tbody>
            </table>
-->
        </div>

        <script>
            // Controls what return values are displayed in the table.
            var showMetrics = bookworm.display_results,
                magazines,
                ssCount = 100,
                ssMaxTerms = 20;

            // Analyze button
            $('#analyzeButton').click( analyzeStory );

            $('#extractionButton').click( extractStory );


            // Text Extraction
            function extractStory() {
                bookworm.extractor.extractText( $('#storyFile').prop('files')[0] )
                    .done( function(data) {
                        $('#storyText').val( data.text );
                    })
                    .fail( displayAjaxError );
            }

            // Local function to analyze the story
            function analyzeStory() {
                $('#results-message').show();
                $('#results').hide();

                // Wipe out prior results
                $( '#analysisTableBody' ).empty();
                $( '#wordFrequencyTableBody' ).empty();
//                 $('#mltTableBody').empty();
//                 $('#knnTableBody').empty();
//                 $('#marketSummary-TableBody').empty();
                $.each( magazines, function( index, magazine ) {
                    $('#' + magazine.id + '-TableBody').empty();
                });

                // Make sure there's text and run analysis
                var story = $('#storyText').val();
                if (story != null && story != '') {
                    var mltSettings = { data: {
                        'stream.body': story,
                        rows: ssCount,
                        'mlt.maxqt': ssMaxTerms } };
                    bookworm.analyzer.analyzeText( story )
                        .done( displayAnalysis )
                        .fail( displayAjaxError );
//                     bookworm.solr.moreLikeThis( mltSettings )
//                         .done( displaySimilarStories )
//                         .fail( displayAjaxError);
                }
            }

            // Show analysis
            function displayAnalysis( data ) {
                var analysisResults = bookworm.analyzer.analysisResultsFactory( data );

                // Populate analysis results
                bookworm.ui.populateAnalysisTableBody( '#analysisTableBody', showMetrics, analysisResults );

                // Start of comparing work to market metrics
                bookworm.solr.getMagazines()
                    .done( function( data ) {
                        var deviations = {};

                        $.each( magazines, function( index, magazine ) {
                            deviations[magazine.id] = [];
                            bookworm.solr.getMagazineStatistics( magazine.name )
                                .done( function( data ) {
                                    var magazineStatistics = bookworm.solr.magazineStatisticsFactory( data ),
                                        tblBodyId = '#' + magazine.id + '-TableBody';
                                    deviations[magazine.id] = [];

                                    $.each( showMetrics, function( undefined, metric ) {
                                        if ( magazineStatistics.stats[metric] ) {
                                            var svgId = magazine.id + '-' + metric,
                                                metricStats = magazineStatistics.stats[metric],
                                                svgWidth = $( '#marketComparison' ).parent().width() * 0.9,
                                                mean = metricStats.mean,
                                                stdDev = metricStats.stddev,
                                                dev = ( analysisResults[metric] - mean) / stdDev,
                                                point;

                                            // Keep the point from going off the charts
                                            dev = dev > 3 ? 3 : dev;
                                            point = ( svgWidth / 2 ) + (dev * (svgWidth / 6));
                                            deviations[magazine.id].push( Math.abs( dev ) );

                                            $( tblBodyId ).append(
                                                '<tr><td class="text-center">' +
                                                bookworm.getFieldLabel( metric ) +
                                                '<br /><svg id="' + svgId +
                                                '" height="30"></svg>' +
                                                '</td></tr>'
                                            );
                                            $( '#' + svgId ).width( svgWidth );
                                            bookworm.ui.drawLineGauge( svgId, svgWidth, point, 'center' );
                                        }
                                    });
                                    // Add a bar to the summary table
                                    var svgId = magazine.id + '-summary',
                                        svgWidth = $( '#marketComparison' ).parent().width() * 0.9,
                                        dev = bookworm.mean( deviations[magazine.id] ),
                                        point;

                                    // Keep the point from going off the charts
                                    dev = dev > 3 ? 3 : dev;
                                    point = svgWidth - (dev * (svgWidth / 3) )
                                    deviations[magazine.id].push( dev );

                                    $( '#marketSummary-TableBody' ).append(
                                        '<tr><td class="text-center">' +
                                        magazine.name + ' (' + magazine.totalStories +
                                        ' stories)<br /><svg id="' + svgId +
                                        '" height="30"></svg>' +
                                        '</td></tr>'
                                    );
                                    $( '#' + svgId ).width( svgWidth );
                                    bookworm.ui.drawLineGauge( svgId, svgWidth, point, 'right' );
                                });
                        });
                        $( '#marketComparison' )
                            .accordion({
                                active: 0,
                                collapsible: true,
                                animate: 50,
                            })
                            .show();
                    });

                // Populate Word Frequency Table
                $.each( analysisResults.word_frequency, function( index, value ) {
                    word_pct = ( value.count / analysisResults.word_count ) * 100;
                    $( '#wordFrequencyTableBody' ).append(
                        "<tr id=\"wordcount-" + value.word + "\">" +
                        "<td>" + value.word + "</td>" +
                        "<td class=\"text-right\">" + value.count + "</td>" +
                        "<td class=\"text-right\">" +
                        Number( word_pct ).toFixed( 4 ) + " %</td>" +
                        "</tr>"
                    );
                });


                // Show the results div
                $('#results-message').hide();
                $('#results').show();
            }

            // Show similar stories
            function displaySimilarStories( data ) {
                var docs = data.response.docs,
                    magazineCounts = {},
                    magazineScores = [];
                bookworm.ui.populateMltTableBody('#mltTableBody', docs);

                $.each( magazines, function( index, magazine ) {
                    var magazineDocs = $.grep( docs, function( e ) {
                            return e.magazine === magazine.name;
                        }),
                        totalScores = 0,
                        avgScore = 0;

                    $.each( magazineDocs, function( index, magazineDoc ) {
                        totalScores += magazineDoc.score;
                    });
                    avgScore = ( magazineDocs.length > 0 ) ?
                        totalScores / magazineDocs.length :
                        0;
                    magazineScores.push( {
                        magazine: magazine.name,
                        totalScores: totalScores,
                        avgScore: avgScore,
                        totalStories: magazineDocs.length,
                    } );
                });
                magazineScores.sort( function( a, b ) {
                    return b.avgScore - a.avgScore;
                });
                $.each( magazineScores, function( index, magazineScore ) {
                    $( '#knnTableBody' ).append(
                        "<tr><td>" + magazineScore.magazine + "</td>" +
                        "<td class=\"text-right\">" + magazineScore.avgScore.toFixed(3) + "</td>" +
                        "<td class=\"text-right\">" + magazineScore.totalStories + "</td>" +
                        "</tr>"
                    );
                });
            }

            // Log Ajax Error
            function displayAjaxError( thrownMessage ) {
                console.log(thrownMessage);
            }

            $( document ).ready( function() {
                $( '.ss-title' ).append(
                    'Top ' + ssCount + ' Similar Stories'
                );
                // Prep Market Comparison Tables
                bookworm.solr.getMagazines()
                    .done( function( data ) {
                        magazines = bookworm.solr.magazinesFactory( data );
                        $.each( magazines, function( index, magazine ) {
                            $( '#marketComparison' ).append(
                                '<p>' + magazine.name + '</p>' +
                                '<table class="scrollTable" id="' +  magazine.id + '">' +
                                '<tbody id="' + magazine.id + '-TableBody"></tbody>' +
                                '</table>'
                            );
                        });
                        $( '#story' ).show();
                    });
                // Collapse the readme
                $( '#readme' ).accordion({
                    active: null,
                    collapsible: true,
                    animate: 50,
                });
            });

        </script>
